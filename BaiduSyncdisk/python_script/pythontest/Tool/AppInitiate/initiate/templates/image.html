<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>启动速度测试</title>
</head>
<body>
<form id="form" action="/index/" method="post">
    <img id="image" src="" width="200" height="400">

    {% if screen_recording_time %}
    <hr>
    <p>
        录屏时长： {{ screen_recording_time.0 }}
    </p>
    {% endif %}

    {% if len_image_files %}
    <p>
        录屏时长： {{ len_image_files.0 }}
    </p>
    {% endif %}

    <hr>
    <input type="button" value="上一张" onclick="showPreviousImage()">
    <input type="button" value="下一张" onclick="showNextImage()">
    <hr>
    <input type="button" value="设置初始帧" onclick="setStartFrame()">
    <input type="hidden" id="startFrame" name="startFrame" value="">
    <input type="button" value="设置结束帧" onclick="setEndFrame()">
    <input type="hidden" id="endFrame" name="endFrame" value="">
    <hr>
    <input type="submit" value="计算耗时" onclick="sendFrameData()">
    <hr>
    <!-- 用来保存录屏时长/图片总数/初始/结束帧，在特定条件下显示 -->
    <input type="hidden" id="screen_recording_time" name="screen_recording_time" value="">
    <input type="hidden" id="len_image_files" name="len_image_files" value="">
</form>
<script>
    var imageIndex = 0; // 当前图片索引
    var images = []; // 用于存储图片路径的数组
    var startFrame = null; // 初始帧
    var endFrame = null; // 结束帧



    // 设置录屏时长显示
    var screen_recording_time = {{ screen_recording_time.0 }}  // 录屏时长
    document.getElementById('screen_recording_time').value = screen_recording_time;
    // 设置图片总数显示
    var len_image_files = {{ len_image_files.0 }}  // 图片总数
    document.getElementById('len_image_files').value = len_image_files;

    // 从服务器渲染的JSON数据
    var image_files_json = {{ image_files_json|safe }}; // 使用|safe过滤器以避免HTML转义

    // 定义MEDIA_URL变量
    var MEDIA_URL = "{{ MEDIA_URL }}";

    // 遍历JSON数据并填充images数组
    image_files_json.forEach(function(image) {
        // 处理每一个数据项
        var image_file = MEDIA_URL + '/' + image[0] + '/' + image[1];
        images.push(image_file); // 将完整的图片路径添加到images数组中
    });

    // 页面加载完成后，显示第一张图片
    window.onload = function() {
        updateImage(); // 更新图片
    };

    // 切换上一张图片
    function showPreviousImage() {
        if (imageIndex > 0) {
            imageIndex--;
        }
        updateImage(); // 更新图片
    }

    // 切换下一张图片
    function showNextImage() {
        if (imageIndex < images.length - 1) {
            imageIndex++;
        }
        updateImage(); // 更新图片
    }

    // 更新图片元素的src属性，从而显示新图片
    function updateImage() {
        var imgElement = document.getElementById('image');
        if (images.length > 0) {
            imgElement.src = images[imageIndex]; // 使用images数组中的路径
        }
    }

    // 设置初始帧
    function setStartFrame() {
        startFrame = imageIndex;
        document.getElementById('startFrame').value = startFrame;
        document.getElementById('startFrame').type = "text";
        console.log("初始帧设置为: ", startFrame);
    }

    // 设置结束帧
    function setEndFrame() {
        endFrame = imageIndex;
        document.getElementById('endFrame').value = endFrame;
        document.getElementById('endFrame').type = "text";
        console.log("结束帧设置为: ", endFrame);
    }

    // 在指定元素前插入一个新的标签
    function insertTagBefore(targetId, newTagType, newText) {
        // 获取目标元素
        var targetElement = document.getElementById(targetId);

        // 如果目标元素不存在，则返回
        if (!targetElement) {
            console.error('目标元素不存在');
            return;
        }

        // 创建新的标签元素
        var newElement = document.createElement(newTagType);

        // 如果提供了文本内容，则设置新标签的文本内容
        if (newText) {
            newElement.textContent = newText;
        }

        // 获取目标元素的父元素
        var parentElement = targetElement.parentNode;

        // 将新标签插入到目标元素之前
        if (parentElement) {
            parentElement.insertBefore(newElement, targetElement);
        }
    }

    // 使用AJAX发送初始/结束帧数据
    function sendFrameData() {
        var xhr = new XMLHttpRequest();
        // 确保URL是正确的，这里假设您的Django服务器运行在本地的8000端口
        xhr.open("POST", "", true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");  // 发送表单数据
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                console.log("Server response: ", xhr.responseText);
            }
        };
        // 确保DOM元素存在并且有值
        var startFrameValue = document.getElementById('startFrame').value;
        var endFrameValue = document.getElementById('endFrame').value;
        var screen_recording_time_Value = document.getElementById('screen_recording_time').value;
        var len_image_files_Value = document.getElementById('len_image_files').value;
        console.log(startFrameValue)
        console.log(endFrameValue)
        console.log(screen_recording_time_Value)
        console.log(len_image_files_Value)
        if (startFrameValue && endFrameValue) {
            var data = "startFrame=" + encodeURIComponent(startFrameValue) +
            "&endFrame=" + encodeURIComponent(endFrameValue) +
            "&screen_recording_time=" + encodeURIComponent(screen_recording_time_Value) +
            "&len_image_files=" + encodeURIComponent(len_image_files_Value);
            xhr.send(data);
        } else {
            console.error('StartFrame or EndFrame value is missing.');
        }
    }
</script>
</body>
</html>